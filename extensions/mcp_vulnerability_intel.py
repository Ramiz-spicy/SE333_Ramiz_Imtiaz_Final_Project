from fastmcp import FastMCP
import subprocess
import json

mcp = FastMCP("Vulnerability Intelligence Tool")

cve_db = {
    "commons-lang3": {
        "3.1": {"cves": ["CVE-2017-12345"], "cvss": 7.5, "fix": "3.12.0"},
        "3.3": {"cves": ["CVE-2019-9936"], "cvss": 6.3, "fix": "3.12.0"}
    },
    "log4j": {
        "2.14.0": {"cves": ["CVE-2021-44228"], "cvss": 10.0, "fix": "2.17.2"},
        "2.15.0": {"cves": ["CVE-2021-45046"], "cvss": 9.0, "fix": "2.17.2"}
    }
}

@mcp.tool()
def vulnerability_scan(project_path: str):
    cmd = ["mvn", "dependency:tree", "-DoutputType=json"]
    proc = subprocess.Popen(cmd, cwd=project_path, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    out, err = proc.communicate()

    try:
        deps = json.loads(out)
    except:
        return {"error": "dependency tree not found"}

    results = []
    risk_score = 0

    for d in deps.get("dependencies", []):
        artifact = d.get("artifactId", "").lower()
        version = d.get("version", "")
        if artifact in cve_db and version in cve_db[artifact]:
            entry = cve_db[artifact][version]
            risk_score += entry["cvss"]
            results.append({
                "artifact": artifact,
                "version": version,
                "cves": entry["cves"],
                "cvss": entry["cvss"],
                "recommended_fix": entry["fix"]
            })

    overall = "critical" if risk_score > 15 else "high" if risk_score > 10 else "medium" if risk_score > 5 else "low"

    return {
        "vulnerabilities": results,
        "risk_score": risk_score,
        "overall_risk": overall
    }

if __name__ == "__main__":
    mcp.run()
